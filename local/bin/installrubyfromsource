#!/bin/sh
set -e

TAG="v${1-$(getcurrentrubyversion | sed 's/\./_/g')}"
SOURCE="$HOME/.local/source/ruby"

mkdir -p "$(dirname "$SOURCE")"
if [ ! -d "$SOURCE" ]; then
  git clone https://github.com/ruby/ruby "$SOURCE"
fi
cd "$SOURCE"
git fetch origin --tags
git reset --hard

cat<<PACKAGES | xargs apt-get install -y
autoconf
bison
build-essential
curl
git
libffi-dev
libgdbm-dev
libncurses5-dev
libreadline-dev
libreadline-dev
libssl-dev
libyaml-dev
zlib1g-dev
PACKAGES

git checkout "$TAG"
autoconf
./configure --prefix="$PREFIX"

make clean
make
make install
